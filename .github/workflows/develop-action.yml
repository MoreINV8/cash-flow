name: "Develop GitHub ActionðŸŒ±ðŸŒ±ðŸŒ±"
run-name: "${{ github.actor }} is developing on ${{ github.ref }}"

on:
    push:
        branches:
            - develop
    pull_request:
        branches:
            - develop

permissions: 
    contents: read
    pull-requests: write

jobs:
    test:

        env:
            DATABASE_URL: jdbc:mysql://127.0.0.1:3306/${{ secrets.MYSQL_DATABASE }}
            DATABASE_USERNAME: root
            DATABASE_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}

        services:
            mysql:
                image: mysql:8.0
                ports:
                    - 3306:3306
                env:
                    MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
                    MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
                options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install MySQL Client
              run: sudo apt-get install -y mysql-client

            - name: Wait for MySQL
              run: |
                for i in {30..0}; do
                    if mysqladmin ping -h127.0.0.1 -uroot -p${{ secrets.MYSQL_ROOT_PASSWORD }} --silent; then
                    echo "MySQL is up!";
                    break;
                    fi
                    echo 'Waiting for MySQL...';
                    sleep 2;
                done

            - name: Set up JDK 21 for x64
              uses: actions/setup-java@v4
              with:
                java-version: '21'
                distribution: 'temurin'

            - name: build maven
              working-directory: ./backend
              run: mvn --batch-mode --update-snapshots verify